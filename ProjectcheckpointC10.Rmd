---
title: "Untitled"
author: "Joubin Zahrir"
date: "2025-06-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(catboost)
library(ggplot2)

# Load dataset
df <- read.csv("survey_us_salary_filtered.csv", stringsAsFactors = FALSE)

# Define categorical columns
cat_cols <- c("main_branch_label", "age_label", "remote_work_label",
              "ed_level_label", "dev_type_label", "org_size_label",
              "purchase_influence_label")

# Convert character columns to factors (do NOT modify NAs)
df[cat_cols] <- lapply(df[cat_cols], factor)

```

```{r}
# Count missing values in each column
na_counts <- sapply(df, function(x) sum(is.na(x)))
na_counts[na_counts > 0]  # Show only columns with missing values

```
```{r}
library(dplyr)

df_cleaned_subset <- df_cleaned %>%
  filter(!is.na(years_code_pro),
         !is.na(dev_type_label),
         !is.na(org_size_label))

```

```{r}
# Total number of rows (observations)
nrow(df_cleaned)


# Optional: Only show columns that still have any NAs
na_summary[na_summary > 0]

```

```{r}
# View the unique categories and their frequency in dev_type_label
table(df_cleaned_subset$dev_type_label)

```
```{r}
# Assign "Other" to roles with < 20 entries, keep others as-is
df_cleaned_subset$dev_type_grouped <- dplyr::case_when(
  df_cleaned_subset$dev_type_label == "Blockchain" ~ "Other",
  df_cleaned_subset$dev_type_label == "Marketing or sales professional" ~ "Other",
  df_cleaned_subset$dev_type_label == "Project manager" ~ "Other",
  df_cleaned_subset$dev_type_label == "Product manager" ~ "Other",
  df_cleaned_subset$dev_type_label == "Student" ~ "Other",
  df_cleaned_subset$dev_type_label == "Educator" ~ "Other",
  df_cleaned_subset$dev_type_label == "Developer Advocate" ~ "Other",
  df_cleaned_subset$dev_type_label == "Developer Experience" ~ "Other",
  df_cleaned_subset$dev_type_label == "Database administrator" ~ "Other",
  df_cleaned_subset$dev_type_label == "Designer" ~ "Other",
  df_cleaned_subset$dev_type_label == "Hardware Engineer" ~ "Other",
  
  TRUE ~ as.character(df_cleaned_subset$dev_type_label)
)

# Convert to factor for modeling
df_cleaned_subset$dev_type_grouped <- as.factor(df_cleaned_subset$dev_type_grouped)

```

```{r}
table(df_cleaned_subset$dev_type_grouped)

```

```{r}
table(df_cleaned_subset$ed_level_label)

```
```{r}
# Remove "Something else" from ed_level_label
df_cleaned_subset <- df_cleaned_subset %>%
  filter(ed_level_label != "Something else")

```

```{r}
table(df_cleaned_subset$org_size_label)

```
```{r}
# Remove "I don't know" from org_size_label
df_cleaned_subset <- df_cleaned_subset %>%
  filter(org_size_label != "I donâ€™t know")

```

```{r}
table(df_cleaned_subset$remote_work_label)

```


```{r}
library(catboost)
library(ggplot2)
library(dplyr)

# Create seniority bucket feature
df_cleaned_subset$seniority_bucket <- cut(
  df_cleaned_subset$years_code_pro,
  breaks = c(-Inf, 2, 5, 10, 20, Inf),
  labels = c("Junior", "EarlyMid", "Mid", "Senior", "Expert")
)

# Make sure it's a factor
df_cleaned_subset$seniority_bucket <- as.factor(df_cleaned_subset$seniority_bucket)

# Define the final dataset
df <- df_cleaned_subset

# Define features including new one
features <- c("years_code_pro", "dev_type_grouped", "org_size_label",
              "ed_level_label", "remote_work_label", "seniority_bucket")

# Train-test split
set.seed(123)
train_index <- sample(nrow(df), 0.8 * nrow(df))
train <- df[train_index, ]
test <- df[-train_index, ]

# Create CatBoost Pools (no log transformation)
train_pool <- catboost.load_pool(data = train[features],
                                 label = train$converted_comp_yearly)

test_pool <- catboost.load_pool(data = test[features],
                                label = test$converted_comp_yearly)

# Model parameters
params <- list(
  loss_function = "RMSE",
  iterations = 1000,
  depth = 6,
  learning_rate = 0.03,
  eval_metric = "R2",
  random_seed = 123,
  early_stopping_rounds = 20,
  verbose = 0
)

# Train the model
model <- catboost.train(train_pool, test_pool, params = params)

# Predict
pred <- catboost.predict(model, test_pool)

# Evaluate
SSE <- sum((test$converted_comp_yearly - pred)^2)
SST <- sum((test$converted_comp_yearly - mean(test$converted_comp_yearly))^2)
R2 <- 1 - SSE/SST
RMSE <- sqrt(mean((test$converted_comp_yearly - pred)^2))
cat("R^2 =", round(R2, 3), "   RMSE =", round(RMSE, 0), "\n")

# Feature importance
importance <- catboost.get_feature_importance(model, pool = train_pool)
importance_df <- data.frame(Feature = features, Importance = importance)
importance_df <- importance_df[order(-importance_df$Importance), ]

ggplot(importance_df, aes(x = reorder(Feature, Importance), y = Importance)) +
  geom_col(fill = "#4682B4") +
  coord_flip() +
  labs(title = "Feature Importance", x = "Feature", y = "Importance")

```

